@* This Model will be a list of users, but we'll re-use the FriendViewModel *@
@model IEnumerable<PRN232_Project_MVC.Models.FriendViewModel>
@using System.Text.Json

@{
    ViewData["Title"] = "Blocked Users";
    var userJson = Context.Session.GetString("User");
    string? displayName = null;
    if (!string.IsNullOrEmpty(userJson))
    {
        try
        {
            using var doc = JsonDocument.Parse(userJson);
            if (doc.RootElement.TryGetProperty("FullName", out var fn) && fn.ValueKind == JsonValueKind.String && !string.IsNullOrWhiteSpace(fn.GetString()))
                displayName = fn.GetString();
            else if (doc.RootElement.TryGetProperty("Username", out var un))
                displayName = un.GetString();
        }
        catch { displayName = null; }
    }
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - ChatApp</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Use your new block.css file -->
    <link href="~/css/block.css" rel="stylesheet" />
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="/Home/index" class="logo">ChatApp</a>
            <nav class="main-nav">
                <a href="/User/friend">Friends</a>
                <a href="/User/setting">Settings</a>
                <!-- Set "Block" as the active link on this page -->
                <a href="/User/block" class="active">Block</a>
                @if (!string.IsNullOrEmpty(displayName))
                {
                    <div class="user-actions">
                        <span class="user-greeting">@displayName</span>
                        <form method="post" asp-controller="User" asp-action="Logout" class="logout-form">
                            <button type="submit" class="btn-logout">Log out</button>
                        </form>
                    </div>
                }
                else
                {
                    <a href="@Url.Action("login", "User")">Sign In</a>
                }
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="page-header">
            <h1>Blocked Users</h1>
        </div>

        <div class="header-actions">
            <!-- Display the count of blocked users -->
            <h2 id="blocked-count">@Model.Count() Blocked</h2>

            <!-- This button will use JavaScript to show the modal -->
            <button id="clear-all-btn" class="btn-clear-all" type="button">Clear All</button>
        </div>

        <!-- This form is hidden and is only used by JavaScript for the "Clear All" action -->
        <form id="clear-all-form" asp-controller="User" asp-action="ClearAllBlocked" method="post" style="display: none;"></form>

        @if (Model != null && Model.Any())
        {
            <ul class="blocked-list">
                @foreach (var user in Model)
                {
                    <li class="blocked-item">
                        <div class="user-info">
                            <img src="@(user.AvatarUrl ?? "/images/default-avatar.png")" alt="Avatar">
                            <div class="user-details">
                                <div class="username">@user.Username</div>
                                <div class="fullname">@user.FullName</div>
                            </div>
                        </div>

                        <div class="user-actions">
                            <!-- This form will post to your UserController's Unblock action -->
                            <!-- We use a data-attribute to link it to the modal -->
                            <form asp-controller="User" asp-action="Unblock" asp-route-blockedId="@user.UserId" method="post" class="unblock-form">
                                <button type="button" class="btn-unblock" data-modal-target="modal-overlay" data-modal-text="Are you sure you want to unblock @user.Username?">Unblock</button>
                            </form>
                        </div>
                    </li>
                }
            </ul>
        }
        else
        {
            <div id="no-blocked" class="no-results">You haven't blocked anyone yet.</div>
        }
    </main>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">Confirm Action</h3>
            </div>
            <div class="modal-body">
                <p id="modal-text">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="modal-cancel-btn">Cancel</button>
                <button class="modal-btn confirm" id="modal-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const modalOverlay = document.getElementById('modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            let formToSubmit = null; // This will hold the form we want to submit

            // --- Handle "Unblock" button clicks ---
            document.querySelectorAll('.btn-unblock').forEach(button => {
                button.addEventListener('click', function (event) {
                    // Find the form that this button belongs to
                    formToSubmit = event.target.closest('form');

                    // Get the custom text from the button
                    const text = event.target.getAttribute('data-modal-text') || 'Are you sure you want to unblock this user?';

                    // Configure and show the modal
                    modalTitle.textContent = 'Confirm Unblock';
                    modalText.textContent = text;
                    modalConfirmBtn.style.backgroundColor = 'var(--success)'; // Make confirm button green
                    modalOverlay.style.display = 'flex';
                });
            });

            // --- Handle "Clear All" button click ---
            document.getElementById('clear-all-btn').addEventListener('click', function () {
                // Find the hidden "Clear All" form
                formToSubmit = document.getElementById('clear-all-form');

                // Configure and show the modal
                modalTitle.textContent = 'Confirm Clear All';
                modalText.textContent = 'Are you sure you want to unblock ALL users? This action cannot be undone.';
                modalConfirmBtn.style.backgroundColor = 'var(--danger)'; // Make confirm button red
                modalOverlay.style.display = 'flex';
            });

            // --- Modal "Confirm" button ---
            modalConfirmBtn.addEventListener('click', function () {
                if (formToSubmit) {
                    formToSubmit.submit(); // Submit the stored form
                }
                hideModal();
            });

            // --- Modal "Cancel" button ---
            modalCancelBtn.addEventListener('click', function () {
                hideModal();
            });

            // --- Click overlay to cancel ---
            modalOverlay.addEventListener('click', function (event) {
                if (event.target === modalOverlay) {
                    hideModal();
                }
            });

            function hideModal() {
                modalOverlay.style.display = 'none';
                formToSubmit = null; // Clear the stored form
            }
        });
    </script>
</body>
</html>

